# Проект инфраструктуры: Terraform и Ansible для развёртывания приложения "Сосисочная"

Этот проект демонстрирует использование **Terraform** и **Ansible** для создания и настройки инфраструктуры в **Яндекс.Облаке** для развёртывания приложения "Сосисочная". Проект состоит из двух основных частей:
1. **Terraform**: Создаёт виртуальную машину (ВМ) и сеть VPC в Яндекс.Облаке.
2. **Ansible**: Настраивает ВМ, устанавливая бэкенд и фронтенд приложения "Сосисочная".

Конфигурации хранятся в репозитории GitLab `infrastructure`, с отдельными ветками для Terraform (`terraform`) и Ansible (`ansible`).

---

## Структура проекта

Проект организован следующим образом:

```
infrastructure/
├── terraform/                    # Конфигурации Terraform
│   ├── main.tf                   # Корневой модуль: подключает модули ВМ и сети
│   ├── outputs.tf                # Выходные переменные корневого модуля (например, IP ВМ)
│   ├── provider.tf               # Конфигурация провайдера Яндекс.Облака
│   ├── variables.tf              # Переменные корневого модуля
│   ├── versions.tf               # Ограничения версий Terraform и провайдера
│   ├── terraform.tfvars          # Значения переменных (не коммитится)
│   ├── .gitignore                # Исключает файлы состояния Terraform и чувствительные данные
│   └── modules/                  # Дочерние модули
│       ├── tf-yc-instance/       # Модуль для создания ВМ
│       │   ├── main.tf           # Конфигурация ресурса ВМ
│       │   ├── outputs.tf        # Выходные переменные (например, публичный IP ВМ)
│       │   ├── variables.tf      # Входные переменные для ВМ
│       │   ├── versions.tf       # Версии Terraform и провайдера
│       │   └── ReadMe.md         # Документация модуля
│       └── tf-yc-network/        # Модуль для создания сети VPC
│           ├── main.tf           # Ресурсы сети и подсетей
│           ├── outputs.tf        # Выходные переменные (например, ID подсети)
│           ├── variables.tf      # Входные переменные для сети
│           ├── versions.tf       # Версии Terraform и провайдера
│           └── ReadMe.md         # Документация модуля
├── ansible/                      # Конфигурации Ansible
│   ├── ansible.cfg               # Конфигурация Ansible (таймаут, путь к ролям)
│   ├── playbook.yaml             # Плейбук для развёртывания бэкенда и фронтенда
│   ├── inventory/                # Файл инвентаризации с данными ВМ
│   └── roles/                    # Роли Ansible
│       ├── backend/              # Роль для установки бэкенда
│       │   ├── tasks/main.yml    # Задачи для установки JDK, артефактов и т.д.
│       │   ├── templates/        # Шаблоны для systemd-юнитов
│       │   └── files/            # Статические файлы (при необходимости)
│       └── frontend/             # Роль для установки фронтенда
│           ├── tasks/main.yml    # Задачи для установки Node.js, npm и т.д.
│           ├── templates/        # Шаблоны для systemd-юнитов
│           └── files/            # Статические файлы (при необходимости)
└── README.md                     # Этот файл
```

---

## Предварительные требования

- **Аккаунт Яндекс.Облака**: Доступ к Яндекс.Облаку с токеном сервисного аккаунта, ID облака и каталога.
- **Terraform**: Установлен локально (версия >= 1.0.0).
- **Ansible**: Установлен на управляющем узле (версия, совместимая с плейбуками).
- **Репозиторий GitLab**: Репозиторий `infrastructure` с ветками `terraform` и `ansible`.
- **SSH-ключ**: Пара публичного/приватного SSH-ключей для доступа к ВМ.
- **Репозиторий Nexus**: Доступ к Nexus для загрузки артефактов бэкенда и фронтенда.
- **Yandex Cloud CLI (yc)**: Опционально, для проверки ресурсов или создания списка известных хостов SSH.

---

## Конфигурация Terraform

Terraform-конфигурация создаёт виртуальную машину и сеть VPC в Яндекс.Облаке. Она разделена на модули для удобства и повторного использования.

### Корневой модуль (`terraform/`)
- **Файлы**:
  - `provider.tf`: Настраивает провайдер Яндекс.Облака с параметрами `token`, `cloud_id` и `folder_id` (задаются через `terraform.tfvars` или переменные окружения `TF_VAR_`).
  - `main.tf`: Подключает модули `tf-yc-instance` и `tf-yc-network`, передавая переменные, такие как `image_id`, `zone` и `subnet_id`.
  - `variables.tf`: Определяет входные переменные корневого модуля.
  - `outputs.tf`: Выводит публичный IP-адрес ВМ для доступа.
  - `versions.tf`: Указывает версию Terraform (`>= 1.0.0`) и провайдера Яндекс.Облака.
  - `.gitignore`: Исключает файлы состояния Terraform (например, `terraform.tfstate`, `.terraform/`) и чувствительные файлы (например, `terraform.tfvars`).

### Модуль ВМ (`modules/tf-yc-instance`)
- **Назначение**: Создаёт виртуальную машину (`yandex_compute_instance`) с использованием `cloud-init` для настройки пользователя `ansible` и группы.
- **Файлы**:
  - `main.tf`: Определяет ресурс ВМ с параметрами, такими как `zone`, `platform_id`, размер диска и `cloud-init` для создания пользователя и настройки SSH-доступа.
  - `variables.tf`: Определяет переменные, такие как `image_id`, `zone`, `subnet_id` и `disk_size`, с значениями по умолчанию, где применимо.
  - `outputs.tf`: Выводит публичный IP-адрес ВМ.
  - `versions.tf`: Соответствует версиям Terraform и провайдера корневого модуля.
  - `ReadMe.md`: Описывает назначение модуля, зависимости (провайдер Яндекс.Облака), входные переменные и выходные данные.

### Модуль сети (`modules/tf-yc-network`)
- **Назначение**: Создаёт сеть VPC и подсети в указанных зонах.
- **Файлы**:
  - `main.tf`: Определяет ресурсы `yandex_vpc_network` (именуется `default`) и `yandex_vpc_subnet` с использованием `for_each` для создания подсетей в каждой зоне из `network_zones`.
  - `variables.tf`: Определяет `network_zones` как `set(string)` для указания зон доступности.
  - `outputs.tf`: Выводит ID сети и подсетей для использования в модуле ВМ.
  - `versions.tf`: Соответствует версиям Terraform и провайдера корневого модуля.
  - `ReadMe.md`: Описывает назначение модуля, зависимости, входные переменные и выходные данные.

### Использование
1. Клонируйте репозиторий:
   ```bash
   git clone <gitlab-repo-url>
   cd infrastructure/terraform
   ```
2. Создайте файл `terraform.tfvars` с вашими данными Яндекс.Облака:
   ```hcl
   token     = "<ваш-токен-яндекс-облака>"
   cloud_id  = "<ваш-id-облака>"
   folder_id = "<ваш-id-каталога>"
   ```
3. Инициализируйте Terraform:
   ```bash
   terraform init
   ```
4. Проверьте конфигурацию:
   ```bash
   terraform validate
   ```
5. Разверните ресурсы:
   ```bash
   terraform apply
   ```
6. Подключитесь к ВМ по SSH, используя выведенный публичный IP:
   ```bash
   ssh ansible@<публичный-ip-вм>
   ```
7. Удалите ресурсы после тестирования:
   ```bash
   terraform destroy
   ```
8. Закоммитьте изменения в ветку `terraform` и создайте Merge Request в ветку `main`.

---

## Конфигурация Ansible

Ansible-конфигурация автоматизирует установку бэкенда и фронтенда приложения "Сосисочная" на созданной ВМ.

### Настройка
- **Директория**: `ansible/`
- **Файлы**:
  - `ansible.cfg`: Настраивает Ansible с таймаутом подключения 30 секунд и путём к ролям `roles/`.
  - `inventory/`: Содержит файл инвентаризации с IP-адресом ВМ (из выходных данных Terraform).
  - `playbook.yaml`: Основной плейбук, который применяет роли `backend` и `frontend` к ВМ под пользователем `ansible`.
  - `roles/backend/`: Роль для установки бэкенда.
    - Устанавливает `openjdk-16-jdk`.
    - Создаёт сервисного пользователя.
    - Загружает артефакты бэкенда из Nexus (с параметризацией версии).
    - Создаёт и активирует systemd-юнит для сервиса.
    - Запускает бэкенд.
  - `roles/frontend/`: Роль для установки фронтенда.
    - Устанавливает `nodejs` и `npm` (по инструкции Яндекс.Облака).
    - Создаёт пользователя `www-data`.
    - Создаёт директорию `/var/www-data` с правами `0755` и владельцем `www-data:www-data`.
    - Загружает артефакты фронтенда из Nexus (с параметризацией версии).
    - Создаёт и активирует systemd-юнит для сервиса.
    - Запускает фронтенд.

### Использование
1. Создайте ВМ с помощью Terraform (см. выше).
2. Установите Ansible на управляющий узел:
   ```bash
   sudo apt update
   sudo apt install ansible
   ```
3. Обновите файл `inventory/` с публичным IP ВМ (из выходных данных Terraform).
4. Запустите плейбук:
   ```bash
   cd ansible
   ansible-playbook playbook.yaml
   ```
5. Проверьте развёртывание, обратившись к приложению:
   - Фронтенд: `http://<публичный-ip-вм>`
   - API: `http://<публичный-ip-вм>/api/sausages`
6. Удалите ВМ с помощью Terraform:
   ```bash
   cd ../terraform
   terraform destroy
   ```
7. Закоммитьте изменения в ветку `ansible` и создайте Merge Request в ветку `main`.

---

## Примечания
- **Зеркало Яндекс.Облака**: Если ресурсы HashiCorp недоступны, настройте зеркало провайдера согласно документации Яндекс.Облака.
- **Безопасность**: Убедитесь, что `terraform.tfvars` и другие чувствительные файлы исключены из Git (используйте `.gitignore`).
- **Cloud-Init**: Модуль ВМ использует `#cloud-config` в скрипте `cloud-init` для настройки пользователя `